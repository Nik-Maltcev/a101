<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defect Classifier - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–µ—Ñ–µ–∫—Ç–æ–≤</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
            margin-top: 5px;
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Upload Section */
        .upload-section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 40px;
            max-width: 600px;
            margin: 40px auto;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 50px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-icon { font-size: 56px; margin-bottom: 15px; }
        .upload-text { color: #333; font-size: 18px; margin-bottom: 8px; }
        .upload-hint { color: #999; font-size: 13px; }

        #fileInput { display: none; }

        .file-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .file-info.visible { display: flex; }
        .file-icon { font-size: 24px; }
        .file-name { flex: 1; color: #333; font-weight: 500; word-break: break-all; }
        .remove-file {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
        }
        .remove-file:hover { color: #e74c3c; }

        .btn {
            width: 100%;
            padding: 16px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(17, 153, 142, 0.4);
        }

        /* Progress Section */
        .progress-section {
            display: none;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 40px;
            max-width: 600px;
            margin: 40px auto;
            text-align: center;
        }

        .progress-section.visible { display: block; }

        .status-text {
            color: #333;
            font-weight: 500;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .progress-bar-container {
            background: #e9ecef;
            border-radius: 10px;
            height: 24px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .progress-percent { color: #666; font-size: 14px; }

        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 8px;
            padding: 15px;
            color: #c00;
            margin-top: 20px;
            display: none;
        }

        .error-message.visible { display: block; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner { display: inline-block; animation: spin 1s linear infinite; }

        /* Dashboard Section */
        .dashboard-section {
            display: none;
        }

        .dashboard-section.visible { display: block; }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .stat-card.primary { border-left: 4px solid #667eea; }
        .stat-card.success { border-left: 4px solid #38ef7d; }
        .stat-card.warning { border-left: 4px solid #f6c23e; }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #333;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .chart-container {
            position: relative;
            height: 350px;
        }

        /* Data Table */
        .table-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            width: 300px;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e9ecef;
            cursor: pointer;
        }

        .data-table th:hover { background: #e9ecef; }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            color: #555;
        }

        .data-table tr:hover { background: #f8f9ff; }

        .table-wrapper {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        /* Download Button */
        .download-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .btn-download {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 16px 40px;
            font-size: 18px;
        }

        .new-upload-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            margin-top: 15px;
        }

        .new-upload-btn:hover { text-decoration: underline; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .tab-btn {
            padding: 12px 30px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            color: #667eea;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn:hover { background: #f8f9ff; }
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Domyland Section */
        .domyland-section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 40px;
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .domyland-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .domyland-status.success {
            display: block;
            background: #d4edda;
            color: #155724;
        }

        .domyland-status.error {
            display: block;
            background: #f8d7da;
            color: #721c24;
        }

        .domyland-status.info {
            display: block;
            background: #cce5ff;
            color: #004085;
        }

        .export-result {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .export-result.visible { display: block; }

        .export-result-text {
            margin-bottom: 15px;
            color: #333;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container { padding: 15px; }
            .charts-grid { grid-template-columns: 1fr; }
            .search-input { width: 100%; }
            .tabs { flex-direction: column; }
            .btn-group { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Defect Classifier</h1>
        <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–µ—Ñ–µ–∫—Ç–æ–≤</p>
    </div>

    <div class="main-container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="classifier">üìä –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä</button>
            <button class="tab-btn" data-tab="domyland">üè¢ Domyland API</button>
        </div>

        <!-- Classifier Tab -->
        <div class="tab-content active" id="tab-classifier">
        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ Excel —Ñ–∞–π–ª —Å—é–¥–∞</div>
                <div class="upload-hint">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ ‚Ä¢ —Ç–æ–ª—å–∫–æ .xlsx</div>
            </div>
            <input type="file" id="fileInput" accept=".xlsx">

            <div class="file-info" id="fileInfo">
                <span class="file-icon">üìÑ</span>
                <span class="file-name" id="fileName"></span>
                <button class="remove-file" id="removeFile">√ó</button>
            </div>

            <button class="btn btn-primary" id="uploadBtn" disabled>
                üöÄ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
            </button>
        </div>

        <!-- Progress Section -->
        <div class="progress-section" id="progressSection">
            <div class="status-text">
                <span class="spinner">‚è≥</span>
                <span id="statusMessage">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-percent" id="progressPercent">0%</div>
        </div>

        <!-- Error Message -->
        <div class="error-message" id="errorMessage"></div>

        <!-- Dashboard Section -->
        <div class="dashboard-section" id="dashboardSection">
            <!-- Download Button -->
            <div class="download-section">
                <button class="btn btn-success btn-download" id="downloadBtn">
                    üì• –°–∫–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
                </button>
                <br>
                <button class="new-upload-btn" id="newUploadBtn">‚Üê –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª</button>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card primary">
                    <div class="stat-value" id="totalRows">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="totalCategories">0</div>
                    <div class="stat-label">–ö–∞—Ç–µ–≥–æ—Ä–∏–π –¥–µ—Ñ–µ–∫—Ç–æ–≤</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="topCategory">-</div>
                    <div class="stat-label">–°–∞–º–∞—è —á–∞—Å—Ç–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-title">üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –¥–µ—Ñ–µ–∫—Ç–æ–≤</div>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="table-card">
                <div class="table-header">
                    <div class="chart-title">üìã –î–∞–Ω–Ω—ã–µ</div>
                    <input type="text" class="search-input" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –∫–æ–ª–æ–Ω–∫–∞–º...">
                </div>
                <div class="table-wrapper">
                    <table class="data-table" id="dataTable">
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        </div> <!-- End tab-classifier -->

        <!-- Domyland Tab -->
        <div class="tab-content" id="tab-domyland">
            <div class="domyland-section">
                <h2 style="margin-bottom: 25px; color: #333;">üè¢ –≠–∫—Å–ø–æ—Ä—Ç –∏–∑ Domyland</h2>
                
                <!-- Auth Form -->
                <div id="domylandAuthForm">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-input" id="domylandEmail" placeholder="user@example.com">
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-input" id="domylandPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                    </div>
                    <div class="form-group">
                        <label>Tenant (–∫–æ–¥ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏)</label>
                        <input type="text" class="form-input" id="domylandTenant" value="a101" placeholder="a101">
                    </div>
                    <div class="domyland-status" id="authStatus"></div>
                    <button class="btn btn-primary" id="domylandAuthBtn">üîê –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button>
                </div>

                <!-- Export Form (hidden until auth) -->
                <div id="domylandExportForm" style="display: none;">
                    <div class="domyland-status success" id="authSuccess">‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞</div>
                    
                    <div class="form-group">
                        <label>–¢–∏–ø —ç–∫—Å–ø–æ—Ä—Ç–∞</label>
                        <select class="form-select" id="exportType">
                            <option value="orders">–ó–∞—è–≤–∫–∏ —Å–æ —Å—á–µ—Ç–∞–º–∏</option>
                            <option value="buildings">–û–±—ä–µ–∫—Ç—ã/–∑–¥–∞–Ω–∏—è</option>
                            <option value="customers">–ö–ª–∏–µ–Ω—Ç—ã</option>
                            <option value="places">–ü–æ–º–µ—â–µ–Ω–∏—è</option>
                            <option value="payments">–ü–ª–∞—Ç–µ–∂–∏</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="buildingIdGroup">
                        <label>ID –∑–¥–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <input type="number" class="form-input" id="buildingId" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –≤—Å–µ—Ö">
                    </div>
                    
                    <div class="form-group" id="dateRangeGroup">
                        <label>–ü–µ—Ä–∏–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Ñ–æ—Ä–º–∞—Ç: –î–î.–ú–ú.–ì–ì–ì–ì-–î–î.–ú–ú.–ì–ì–ì–ì)</label>
                        <input type="text" class="form-input" id="dateRange" placeholder="01.01.2024-31.12.2024">
                    </div>
                    
                    <div class="domyland-status" id="exportStatus"></div>
                    <button class="btn btn-primary" id="domylandExportBtn">üì• –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    
                    <div class="export-result" id="exportResult">
                        <div class="export-result-text" id="exportResultText"></div>
                        <div class="btn-group">
                            <button class="btn btn-success" id="downloadExportBtn">üì• –°–∫–∞—á–∞—Ç—å Excel</button>
                            <button class="btn btn-primary" id="processExportBtn">üîÑ –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º</button>
                        </div>
                    </div>
                    
                    <button class="new-upload-btn" id="domylandLogout" style="margin-top: 20px;">üö™ –í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const removeFile = document.getElementById('removeFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadSection = document.getElementById('uploadSection');
        const progressSection = document.getElementById('progressSection');
        const statusMessage = document.getElementById('statusMessage');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const errorMessage = document.getElementById('errorMessage');
        const dashboardSection = document.getElementById('dashboardSection');
        const downloadBtn = document.getElementById('downloadBtn');
        const newUploadBtn = document.getElementById('newUploadBtn');
        const searchInput = document.getElementById('searchInput');

        let selectedFile = null;
        let currentJobId = null;
        let pollInterval = null;
        let analyticsData = null;
        let categoryChart = null;

        const statusMessages = {
            'pending': '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥–∏...',
            'splitting': '‚úÇÔ∏è –†–∞–∑–¥–µ–ª—è—é –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ –¥–µ—Ñ–µ–∫—Ç—ã...',
            'classifying': 'üè∑Ô∏è –ü—Ä–æ—Å—Ç–∞–≤–ª—è—é –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤...',
            'completed': '‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!',
            'failed': '‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏'
        };

        // Drag and drop
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) handleFileSelect(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFileSelect(e.target.files[0]);
        });

        function handleFileSelect(file) {
            if (!file.name.toLowerCase().endsWith('.xlsx')) {
                showError('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã —Ñ–æ—Ä–º–∞—Ç–∞ .xlsx');
                return;
            }
            selectedFile = file;
            fileName.textContent = file.name;
            fileInfo.classList.add('visible');
            uploadBtn.disabled = false;
            hideError();
        }

        removeFile.addEventListener('click', () => {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.classList.remove('visible');
            uploadBtn.disabled = true;
        });

        uploadBtn.addEventListener('click', async () => {
            if (!selectedFile) return;
            uploadBtn.disabled = true;
            hideError();
            showProgress();

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);
                const response = await fetch('/jobs', { method: 'POST', body: formData });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
                }
                const data = await response.json();
                currentJobId = data.job_id;
                startPolling();
            } catch (error) {
                showError(error.message);
                hideProgress();
                uploadBtn.disabled = false;
            }
        });

        function startPolling() {
            pollInterval = setInterval(checkJobStatus, 1500);
            checkJobStatus();
        }

        function stopPolling() {
            if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }
        }

        let pollErrorCount = 0;
        const MAX_POLL_ERRORS = 5;

        async function checkJobStatus() {
            if (!currentJobId) return;
            try {
                const response = await fetch(`/jobs/${currentJobId}`);
                
                if (response.status === 404) {
                    // Job not found - server might have restarted
                    pollErrorCount++;
                    if (pollErrorCount >= MAX_POLL_ERRORS) {
                        stopPolling();
                        showError('–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –°–µ—Ä–≤–µ—Ä –º–æ–≥ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –∑–∞–Ω–æ–≤–æ.');
                        hideProgress();
                    }
                    return;
                }
                
                if (!response.ok) {
                    pollErrorCount++;
                    if (pollErrorCount >= MAX_POLL_ERRORS) {
                        stopPolling();
                        showError('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                        hideProgress();
                    }
                    return;
                }
                
                // Success - reset error count
                pollErrorCount = 0;
                
                const data = await response.json();
                updateProgress(data);

                if (data.status === 'completed') {
                    stopPolling();
                    await loadAnalytics();
                } else if (data.status === 'failed') {
                    stopPolling();
                    showError(data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞');
                    hideProgress();
                }
            } catch (error) {
                // Network error - might be temporary
                pollErrorCount++;
                console.error('Poll error:', error);
                
                if (pollErrorCount >= MAX_POLL_ERRORS) {
                    stopPolling();
                    showError('–ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                    hideProgress();
                }
                // Otherwise continue polling - might recover
            }
        }

        function updateProgress(data) {
            statusMessage.textContent = statusMessages[data.status] || data.status;
            progressBar.style.width = `${data.progress}%`;
            progressPercent.textContent = `${data.progress}%`;
        }

        function showProgress() {
            uploadSection.style.display = 'none';
            progressSection.classList.add('visible');
            dashboardSection.classList.remove('visible');
        }

        function hideProgress() {
            progressSection.classList.remove('visible');
            uploadSection.style.display = 'block';
        }

        async function loadAnalytics() {
            try {
                const response = await fetch(`/jobs/${currentJobId}/analytics`);
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏');
                analyticsData = await response.json();
                showDashboard();
            } catch (error) {
                showError(error.message);
                hideProgress();
            }
        }

        function showDashboard() {
            progressSection.classList.remove('visible');
            dashboardSection.classList.add('visible');

            // Update stats
            document.getElementById('totalRows').textContent = analyticsData.total_rows;
            document.getElementById('totalCategories').textContent = analyticsData.total_categories;
            
            if (analyticsData.category_distribution.length > 0) {
                const topCat = analyticsData.category_distribution[0].category;
                document.getElementById('topCategory').textContent = topCat.length > 25 ? topCat.substring(0, 25) + '...' : topCat;
            }

            // Render chart
            renderCategoryChart();

            // Render table
            renderDataTable();

            // Setup download
            downloadBtn.onclick = () => window.location.href = `/jobs/${currentJobId}/download`;
        }

        function renderCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (categoryChart) categoryChart.destroy();

            const data = analyticsData.category_distribution.slice(0, 15);
            
            if (data.length === 0) {
                ctx.font = '16px Arial';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe',
                '#00f2fe', '#43e97b', '#38f9d7', '#fa709a', '#fee140',
                '#30cfd0', '#330867', '#a8edea', '#fed6e3', '#5ee7df'
            ];

            categoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.category.length > 30 ? d.category.substring(0, 30) + '...' : d.category),
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ñ–µ–∫—Ç–æ–≤',
                        data: data.map(d => d.count),
                        backgroundColor: colors,
                        borderRadius: 6,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const item = data[ctx.dataIndex];
                                    return `${item.count} (${item.percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, grid: { display: false } },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        function renderDataTable() {
            const headers = analyticsData.headers;
            const data = analyticsData.data;

            // Render headers
            const thead = document.getElementById('tableHead');
            thead.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';

            // Render body
            renderTableBody(data);

            // Search functionality
            searchInput.oninput = () => {
                const query = searchInput.value.toLowerCase();
                const filtered = analyticsData.data.filter(row => 
                    Object.values(row).some(v => String(v).toLowerCase().includes(query))
                );
                renderTableBody(filtered);
            };
        }

        function renderTableBody(data) {
            const tbody = document.getElementById('tableBody');
            const headers = analyticsData.headers;
            tbody.innerHTML = data.slice(0, 200).map(row => 
                '<tr>' + headers.map(h => `<td>${row[h] || ''}</td>`).join('') + '</tr>'
            ).join('');
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('visible');
        }

        function hideError() {
            errorMessage.classList.remove('visible');
        }

        newUploadBtn.addEventListener('click', () => {
            selectedFile = null;
            currentJobId = null;
            analyticsData = null;
            pollErrorCount = 0;
            fileInput.value = '';
            fileInfo.classList.remove('visible');
            uploadBtn.disabled = true;
            uploadSection.style.display = 'block';
            progressSection.classList.remove('visible');
            dashboardSection.classList.remove('visible');
            hideError();
            progressBar.style.width = '0%';
            progressPercent.textContent = '0%';
            searchInput.value = '';
        });

        // ========== TABS ==========
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            });
        });

        // ========== DOMYLAND ==========
        let domylandSessionId = null;
        let lastExportUrl = null;

        const domylandAuthBtn = document.getElementById('domylandAuthBtn');
        const domylandExportBtn = document.getElementById('domylandExportBtn');
        const authStatus = document.getElementById('authStatus');
        const exportStatus = document.getElementById('exportStatus');
        const exportResult = document.getElementById('exportResult');
        const domylandAuthForm = document.getElementById('domylandAuthForm');
        const domylandExportForm = document.getElementById('domylandExportForm');

        domylandAuthBtn.addEventListener('click', async () => {
            const email = document.getElementById('domylandEmail').value;
            const password = document.getElementById('domylandPassword').value;
            const tenant = document.getElementById('domylandTenant').value || 'a101';

            if (!email || !password) {
                authStatus.className = 'domyland-status error';
                authStatus.textContent = '–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å';
                return;
            }

            domylandAuthBtn.disabled = true;
            authStatus.className = 'domyland-status info';
            authStatus.textContent = '‚è≥ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–æ–≤...';

            try {
                const response = await fetch('/domyland/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, tenant_name: tenant })
                });
                const data = await response.json();

                if (data.success) {
                    domylandSessionId = data.session_id;
                    
                    // Update export type dropdown with available options
                    const exportTypeSelect = document.getElementById('exportType');
                    exportTypeSelect.innerHTML = '';
                    
                    if (data.available_exports && data.available_exports.length > 0) {
                        data.available_exports.forEach(exp => {
                            const option = document.createElement('option');
                            option.value = exp.id;
                            option.textContent = exp.name;
                            exportTypeSelect.appendChild(option);
                        });
                        
                        // Update auth success message
                        document.getElementById('authSuccess').textContent = 
                            `‚úÖ ${data.message}`;
                        
                        // Trigger change to update form fields
                        exportTypeSelect.dispatchEvent(new Event('change'));
                    } else {
                        authStatus.className = 'domyland-status error';
                        authStatus.textContent = '‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∏–ø–æ–≤ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–ª—è –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞';
                        return;
                    }
                    
                    domylandAuthForm.style.display = 'none';
                    domylandExportForm.style.display = 'block';
                } else {
                    authStatus.className = 'domyland-status error';
                    authStatus.textContent = '‚ùå ' + data.message;
                }
            } catch (error) {
                authStatus.className = 'domyland-status error';
                authStatus.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message;
            } finally {
                domylandAuthBtn.disabled = false;
            }
        });

        // Show/hide fields based on export type
        document.getElementById('exportType').addEventListener('change', (e) => {
            const type = e.target.value;
            document.getElementById('buildingIdGroup').style.display = 
                (type === 'orders' || type === 'places') ? 'block' : 'none';
            document.getElementById('dateRangeGroup').style.display = 
                ['orders', 'payments', 'buildings', 'customers', 'places'].includes(type) ? 'block' : 'none';
        });

        domylandExportBtn.addEventListener('click', async () => {
            if (!domylandSessionId) return;

            const exportType = document.getElementById('exportType').value;
            const buildingId = document.getElementById('buildingId').value;
            const dateRange = document.getElementById('dateRange').value;

            domylandExportBtn.disabled = true;
            exportStatus.className = 'domyland-status info';
            exportStatus.textContent = '‚è≥ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.';
            exportResult.classList.remove('visible');

            try {
                const body = {
                    session_id: domylandSessionId,
                    export_type: exportType,
                };
                if (buildingId) body.building_id = parseInt(buildingId);
                if (dateRange) {
                    if (exportType === 'orders') body.created_at = dateRange;
                    else body.updated_at = dateRange;
                }

                const response = await fetch('/domyland/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await response.json();

                if (data.success) {
                    exportStatus.className = 'domyland-status success';
                    exportStatus.textContent = '‚úÖ ' + data.message;
                    lastExportUrl = data.download_url;
                    document.getElementById('exportResultText').textContent = 
                        `–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${data.record_count} –∑–∞–ø–∏—Å–µ–π`;
                    exportResult.classList.add('visible');
                } else {
                    exportStatus.className = 'domyland-status error';
                    exportStatus.textContent = '‚ùå ' + data.message;
                    if (data.message.includes('–°–µ—Å—Å–∏—è')) {
                        // Session expired, show auth form
                        domylandSessionId = null;
                        domylandAuthForm.style.display = 'block';
                        domylandExportForm.style.display = 'none';
                    }
                }
            } catch (error) {
                exportStatus.className = 'domyland-status error';
                exportStatus.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + error.message;
            } finally {
                domylandExportBtn.disabled = false;
            }
        });

        document.getElementById('downloadExportBtn').addEventListener('click', () => {
            if (lastExportUrl) window.location.href = lastExportUrl;
        });

        document.getElementById('processExportBtn').addEventListener('click', async () => {
            if (!lastExportUrl) return;
            // Download file and upload to classifier
            exportStatus.className = 'domyland-status info';
            exportStatus.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä...';
            
            try {
                const response = await fetch(lastExportUrl);
                const blob = await response.blob();
                const file = new File([blob], 'domyland_export.xlsx', { type: blob.type });
                
                // Switch to classifier tab
                document.querySelector('[data-tab="classifier"]').click();
                
                // Upload file
                handleFileSelect(file);
                uploadBtn.click();
            } catch (error) {
                exportStatus.className = 'domyland-status error';
                exportStatus.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + error.message;
            }
        });

        document.getElementById('domylandLogout').addEventListener('click', () => {
            domylandSessionId = null;
            lastExportUrl = null;
            domylandAuthForm.style.display = 'block';
            domylandExportForm.style.display = 'none';
            exportResult.classList.remove('visible');
            exportStatus.className = 'domyland-status';
            document.getElementById('domylandPassword').value = '';
        });
    </script>
</body>
</html>
