<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defect Classifier - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–µ—Ñ–µ–∫—Ç–æ–≤</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
            margin-top: 5px;
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Upload Section */
        .upload-section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 40px;
            max-width: 600px;
            margin: 40px auto;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 50px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-icon { font-size: 56px; margin-bottom: 15px; }
        .upload-text { color: #333; font-size: 18px; margin-bottom: 8px; }
        .upload-hint { color: #999; font-size: 13px; }

        #fileInput { display: none; }

        .file-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .file-info.visible { display: flex; }
        .file-icon { font-size: 24px; }
        .file-name { flex: 1; color: #333; font-weight: 500; word-break: break-all; }
        .remove-file {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
        }
        .remove-file:hover { color: #e74c3c; }

        .btn {
            width: 100%;
            padding: 16px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(17, 153, 142, 0.4);
        }

        /* Progress Section */
        .progress-section {
            display: none;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 40px;
            max-width: 600px;
            margin: 40px auto;
            text-align: center;
        }

        .progress-section.visible { display: block; }

        .status-text {
            color: #333;
            font-weight: 500;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .progress-bar-container {
            background: #e9ecef;
            border-radius: 10px;
            height: 24px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .progress-percent { color: #666; font-size: 14px; }

        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 8px;
            padding: 15px;
            color: #c00;
            margin-top: 20px;
            display: none;
        }

        .error-message.visible { display: block; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner { display: inline-block; animation: spin 1s linear infinite; }

        /* Dashboard Section */
        .dashboard-section {
            display: none;
        }

        .dashboard-section.visible { display: block; }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .stat-card.primary { border-left: 4px solid #667eea; }
        .stat-card.success { border-left: 4px solid #38ef7d; }
        .stat-card.warning { border-left: 4px solid #f6c23e; }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #333;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .chart-container {
            position: relative;
            height: 350px;
        }

        /* Data Table */
        .table-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            width: 300px;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e9ecef;
            cursor: pointer;
        }

        .data-table th:hover { background: #e9ecef; }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            color: #555;
        }

        .data-table tr:hover { background: #f8f9ff; }

        .table-wrapper {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        /* Download Button */
        .download-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .btn-download {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 16px 40px;
            font-size: 18px;
        }

        .new-upload-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            margin-top: 15px;
        }

        .new-upload-btn:hover { text-decoration: underline; }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container { padding: 15px; }
            .charts-grid { grid-template-columns: 1fr; }
            .search-input { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Defect Classifier</h1>
        <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–µ—Ñ–µ–∫—Ç–æ–≤</p>
    </div>

    <div class="main-container">
        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ Excel —Ñ–∞–π–ª —Å—é–¥–∞</div>
                <div class="upload-hint">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ ‚Ä¢ —Ç–æ–ª—å–∫–æ .xlsx</div>
            </div>
            <input type="file" id="fileInput" accept=".xlsx">

            <div class="file-info" id="fileInfo">
                <span class="file-icon">üìÑ</span>
                <span class="file-name" id="fileName"></span>
                <button class="remove-file" id="removeFile">√ó</button>
            </div>

            <button class="btn btn-primary" id="uploadBtn" disabled>
                üöÄ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
            </button>
        </div>

        <!-- Progress Section -->
        <div class="progress-section" id="progressSection">
            <div class="status-text">
                <span class="spinner">‚è≥</span>
                <span id="statusMessage">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-percent" id="progressPercent">0%</div>
        </div>

        <!-- Error Message -->
        <div class="error-message" id="errorMessage"></div>

        <!-- Dashboard Section -->
        <div class="dashboard-section" id="dashboardSection">
            <!-- Download Button -->
            <div class="download-section">
                <button class="btn btn-success btn-download" id="downloadBtn">
                    üì• –°–∫–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
                </button>
                <br>
                <button class="new-upload-btn" id="newUploadBtn">‚Üê –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª</button>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card primary">
                    <div class="stat-value" id="totalRows">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="totalCategories">0</div>
                    <div class="stat-label">–ö–∞—Ç–µ–≥–æ—Ä–∏–π –¥–µ—Ñ–µ–∫—Ç–æ–≤</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="topCategory">-</div>
                    <div class="stat-label">–°–∞–º–∞—è —á–∞—Å—Ç–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-title">üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –¥–µ—Ñ–µ–∫—Ç–æ–≤</div>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="table-card">
                <div class="table-header">
                    <div class="chart-title">üìã –î–∞–Ω–Ω—ã–µ</div>
                    <input type="text" class="search-input" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –∫–æ–ª–æ–Ω–∫–∞–º...">
                </div>
                <div class="table-wrapper">
                    <table class="data-table" id="dataTable">
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const removeFile = document.getElementById('removeFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadSection = document.getElementById('uploadSection');
        const progressSection = document.getElementById('progressSection');
        const statusMessage = document.getElementById('statusMessage');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const errorMessage = document.getElementById('errorMessage');
        const dashboardSection = document.getElementById('dashboardSection');
        const downloadBtn = document.getElementById('downloadBtn');
        const newUploadBtn = document.getElementById('newUploadBtn');
        const searchInput = document.getElementById('searchInput');

        let selectedFile = null;
        let currentJobId = null;
        let pollInterval = null;
        let analyticsData = null;
        let categoryChart = null;

        const statusMessages = {
            'pending': '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥–∏...',
            'splitting': '‚úÇÔ∏è –†–∞–∑–¥–µ–ª—è—é –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ –¥–µ—Ñ–µ–∫—Ç—ã...',
            'classifying': 'üè∑Ô∏è –ü—Ä–æ—Å—Ç–∞–≤–ª—è—é –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤...',
            'completed': '‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!',
            'failed': '‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏'
        };

        // Drag and drop
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) handleFileSelect(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFileSelect(e.target.files[0]);
        });

        function handleFileSelect(file) {
            if (!file.name.toLowerCase().endsWith('.xlsx')) {
                showError('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã —Ñ–æ—Ä–º–∞—Ç–∞ .xlsx');
                return;
            }
            selectedFile = file;
            fileName.textContent = file.name;
            fileInfo.classList.add('visible');
            uploadBtn.disabled = false;
            hideError();
        }

        removeFile.addEventListener('click', () => {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.classList.remove('visible');
            uploadBtn.disabled = true;
        });

        uploadBtn.addEventListener('click', async () => {
            if (!selectedFile) return;
            uploadBtn.disabled = true;
            hideError();
            showProgress();

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);
                const response = await fetch('/jobs', { method: 'POST', body: formData });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
                }
                const data = await response.json();
                currentJobId = data.job_id;
                startPolling();
            } catch (error) {
                showError(error.message);
                hideProgress();
                uploadBtn.disabled = false;
            }
        });

        function startPolling() {
            pollInterval = setInterval(checkJobStatus, 1500);
            checkJobStatus();
        }

        function stopPolling() {
            if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }
        }

        async function checkJobStatus() {
            if (!currentJobId) return;
            try {
                const response = await fetch(`/jobs/${currentJobId}`);
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                const data = await response.json();
                updateProgress(data);

                if (data.status === 'completed') {
                    stopPolling();
                    await loadAnalytics();
                } else if (data.status === 'failed') {
                    stopPolling();
                    showError(data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞');
                    hideProgress();
                }
            } catch (error) {
                stopPolling();
                showError(error.message);
                hideProgress();
            }
        }

        function updateProgress(data) {
            statusMessage.textContent = statusMessages[data.status] || data.status;
            progressBar.style.width = `${data.progress}%`;
            progressPercent.textContent = `${data.progress}%`;
        }

        function showProgress() {
            uploadSection.style.display = 'none';
            progressSection.classList.add('visible');
            dashboardSection.classList.remove('visible');
        }

        function hideProgress() {
            progressSection.classList.remove('visible');
            uploadSection.style.display = 'block';
        }

        async function loadAnalytics() {
            try {
                const response = await fetch(`/jobs/${currentJobId}/analytics`);
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏');
                analyticsData = await response.json();
                showDashboard();
            } catch (error) {
                showError(error.message);
                hideProgress();
            }
        }

        function showDashboard() {
            progressSection.classList.remove('visible');
            dashboardSection.classList.add('visible');

            // Update stats
            document.getElementById('totalRows').textContent = analyticsData.total_rows;
            document.getElementById('totalCategories').textContent = analyticsData.total_categories;
            
            if (analyticsData.category_distribution.length > 0) {
                const topCat = analyticsData.category_distribution[0].category;
                document.getElementById('topCategory').textContent = topCat.length > 25 ? topCat.substring(0, 25) + '...' : topCat;
            }

            // Render chart
            renderCategoryChart();

            // Render table
            renderDataTable();

            // Setup download
            downloadBtn.onclick = () => window.location.href = `/jobs/${currentJobId}/download`;
        }

        function renderCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (categoryChart) categoryChart.destroy();

            const data = analyticsData.category_distribution.slice(0, 15);
            
            if (data.length === 0) {
                ctx.font = '16px Arial';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe',
                '#00f2fe', '#43e97b', '#38f9d7', '#fa709a', '#fee140',
                '#30cfd0', '#330867', '#a8edea', '#fed6e3', '#5ee7df'
            ];

            categoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.category.length > 30 ? d.category.substring(0, 30) + '...' : d.category),
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ñ–µ–∫—Ç–æ–≤',
                        data: data.map(d => d.count),
                        backgroundColor: colors,
                        borderRadius: 6,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const item = data[ctx.dataIndex];
                                    return `${item.count} (${item.percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, grid: { display: false } },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        function renderDataTable() {
            const headers = analyticsData.headers;
            const data = analyticsData.data;

            // Render headers
            const thead = document.getElementById('tableHead');
            thead.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';

            // Render body
            renderTableBody(data);

            // Search functionality
            searchInput.oninput = () => {
                const query = searchInput.value.toLowerCase();
                const filtered = analyticsData.data.filter(row => 
                    Object.values(row).some(v => String(v).toLowerCase().includes(query))
                );
                renderTableBody(filtered);
            };
        }

        function renderTableBody(data) {
            const tbody = document.getElementById('tableBody');
            const headers = analyticsData.headers;
            tbody.innerHTML = data.slice(0, 200).map(row => 
                '<tr>' + headers.map(h => `<td>${row[h] || ''}</td>`).join('') + '</tr>'
            ).join('');
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('visible');
        }

        function hideError() {
            errorMessage.classList.remove('visible');
        }

        newUploadBtn.addEventListener('click', () => {
            selectedFile = null;
            currentJobId = null;
            analyticsData = null;
            fileInput.value = '';
            fileInfo.classList.remove('visible');
            uploadBtn.disabled = true;
            uploadSection.style.display = 'block';
            progressSection.classList.remove('visible');
            dashboardSection.classList.remove('visible');
            hideError();
            progressBar.style.width = '0%';
            progressPercent.textContent = '0%';
            searchInput.value = '';
        });
    </script>
</body>
</html>
