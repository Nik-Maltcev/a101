# Процесс обработки дефектов

## Общая схема

```
Excel файл → [1. Чтение] → [2. Split LLM] → [3. Expand] → [4. Classify LLM] → Excel результат
```

## Этапы обработки

### 1. Чтение Excel файла
**Файл:** `app/services/excel_reader.py`

- Открываем загруженный .xlsx файл
- Читаем все строки с заголовками
- Для каждой строки сцепляем `valueString` + `valueText` в один комментарий
- Пример: valueString="Окно 2", valueText="1Царапины 2Трещины" → "Окно 2 1Царапины 2Трещины"

### 2. Split (Разделение дефектов)
**Файл:** `app/services/split_service.py`, `app/services/llm_client.py`

- Отправляем все комментарии в **Deepseek-reasoner** (LLM)
- LLM анализирует текст и разделяет на отдельные дефекты
- Правила разделения:
  - Номера (1, 2, 3 или 1., 2., 3. или 1Текст 2Текст) = разные дефекты
  - Точка с запятой (;) = разные дефекты
  - Отдельные предложения = разные дефекты
- Пример входа: "1Царапины на окне 2Трещина в раме 3Зазоры"
- Пример выхода: ["Царапины на окне", "Трещина в раме", "Зазоры"]

### 3. Expand (Размножение строк)
**Файл:** `app/services/expand_service.py`

- Для каждой исходной строки создаём N копий (где N = количество дефектов)
- Каждая копия содержит все оригинальные данные
- Добавляется колонка "Дефект" с текстом одного дефекта
- Пример: 1 строка с 7 дефектами → 7 строк (каждая с 1 дефектом)

### 4. Classify (Классификация)
**Файл:** `app/services/classify_service.py`, `app/services/category_index.py`

- Загружаем 579 категорий из `data/categories1.xlsx`
- Для каждого дефекта:
  1. Ищем топ-40 похожих категорий через **rapidfuzz** (быстрый fuzzy matching)
  2. Отправляем дефект + 40 кандидатов в **Deepseek-reasoner**
  3. LLM выбирает наиболее подходящую категорию
- Результат записывается в колонку "Категория дефекта"

### 5. Запись результата
**Файл:** `app/services/excel_writer.py`

- Создаём новый Excel файл
- Сохраняем все оригинальные колонки
- Добавляем колонки: "Дефект", "Категория дефекта"
- Файл доступен для скачивания

## Конфигурация
**Файл:** `app/config.py`

| Параметр | Значение | Описание |
|----------|----------|----------|
| LLM_MODEL | deepseek-reasoner | Модель для анализа |
| SPLIT_BATCH_SIZE | 50 | Комментариев в одном запросе split |
| CLASSIFY_BATCH_SIZE | 20 | Дефектов в одном запросе classify |
| CLASSIFY_CONCURRENT_BATCHES | 3 | Параллельных запросов classify |
| CATEGORIES_FILE | data/categories1.xlsx | Файл с 579 категориями |

## Текущая проблема

**Симптом:** Строки с 7 дефектами в valueText возвращают 0 дефектов после Split.

**Пример:**
- Вход: "Окно 2 1Царапины... 2Отслоение... 3Зазоры... 4Зазоры... 5Микро трещина... 6Понижение... 7Загрязнения..."
- Ожидаемый выход: 7 отдельных дефектов
- Фактический выход: 0 дефектов (строка пропускается)

**Гипотеза:** LLM неправильно парсит ответ или возвращает результаты в неправильном порядке.
